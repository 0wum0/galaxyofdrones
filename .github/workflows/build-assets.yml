# -------------------------------------------------------------------
# Build Frontend Assets & Commit to master
# -------------------------------------------------------------------
# Laravel Mix (webpack) build — outputs:
#   public/js/app.js, public/js/vendor.js, public/js/manifest.js
#   public/css/app.css
#   public/mix-manifest.json
#
# Hostinger shared hosting has no Node.js, so we build here and
# commit the compiled assets back into the branch.
# -------------------------------------------------------------------

name: Build Assets

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-assets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-commit:
    # Skip if the last commit was made by this workflow (prevent infinite loop)
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js 16
        uses: actions/setup-node@v4
        with:
          # Node 16 required — Laravel Mix 6 + PostCSS 8.2 are incompatible
          # with Node 18+ (ERR_PACKAGE_PATH_NOT_EXPORTED on postcss/package.json)
          node-version: 16
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build production assets
        run: yarn prod

      - name: Verify build output exists
        run: |
          echo "--- Checking build artifacts ---"
          for f in public/js/app.js public/js/vendor.js public/js/manifest.js public/css/app.css public/mix-manifest.json; do
            if [ ! -f "$f" ]; then
              echo "ERROR: $f is missing!"
              exit 1
            fi
            SIZE=$(wc -c < "$f")
            echo "OK: $f ($SIZE bytes)"
            if [ "$SIZE" -lt 500 ]; then
              echo "WARNING: $f seems too small ($SIZE bytes) — possible placeholder?"
            fi
          done
          echo "--- All build artifacts present ---"

      - name: Verify CSS asset references
        run: |
          echo "--- Verifying CSS url() asset references ---"
          MISSING=0
          # Extract relative url() paths from compiled CSS (skip data:, http:, https:, #)
          URLS=$(grep -oP 'url\(\K[^)]+' public/css/app.css \
            | sed "s/['\"]//g" \
            | sed 's/[?#].*//' \
            | grep -v '^data:' \
            | grep -v '^https\?:' \
            | grep -v '^#' \
            | sort -u)
          for REL in $URLS; do
            # Resolve relative path from public/css/ directory
            RESOLVED="public/css/$REL"
            # Normalize (handle ../)
            RESOLVED=$(realpath --relative-to=. -m "$RESOLVED")
            if [ ! -f "$RESOLVED" ]; then
              echo "MISSING: $REL -> $RESOLVED"
              MISSING=$((MISSING + 1))
            else
              echo "OK: $REL -> $RESOLVED"
            fi
          done
          if [ "$MISSING" -gt 0 ]; then
            echo "ERROR: $MISSING CSS asset reference(s) could not be resolved!"
            exit 1
          fi
          echo "--- All CSS asset references verified ---"

      - name: Commit built assets
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage only the build output directories/files
          git add -f public/js/app.js public/js/vendor.js public/js/manifest.js
          git add -f public/css/app.css
          git add -f public/css/images/
          git add -f public/mix-manifest.json
          git add -f public/images/

          # Only commit if there are actual changes
          if git diff --cached --quiet; then
            echo "No asset changes to commit."
          else
            git commit -m "chore: rebuild frontend assets [skip ci]"
            git push origin master
            echo "Assets committed and pushed."
          fi
