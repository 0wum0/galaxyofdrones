# Root .htaccess - Safety net when DocumentRoot is the project root (not /public).
# Ideally, DocumentRoot should point to /public. This file handles the fallback.
#
# IMPORTANT: HTTPS enforcement happens HERE (before the /public/ rewrite) so that
# the redirect URL never contains "/public/" in the path. If the HTTPS redirect
# were only in public/.htaccess, the rewrite to /public/$1 would run first,
# making %{REQUEST_URI} = /public/..., and the 301 redirect would expose
# "/public/" in the browser URL. That breaks Vue Router (history mode, no base)
# and looks wrong to users.

<IfModule mod_rewrite.c>
    RewriteEngine On

    # ── 1. Force HTTPS (before any internal rewrite) ──────────────
    # Must happen here so the redirect preserves the ORIGINAL request URI
    # (without the /public/ prefix that the rewrite below would add).
    RewriteCond %{HTTPS} !=on
    RewriteCond %{HTTP:X-Forwarded-Proto} !=https
    RewriteCond %{HTTP:X-Forwarded-Ssl} !=on
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # ── 2. Block access to sensitive directories (return 403) ─────
    RewriteRule ^vendor(/.*)?$ - [F,L]
    RewriteRule ^storage(/.*)?$ - [F,L]
    RewriteRule ^bootstrap(/.*)?$ - [F,L]
    RewriteRule ^config(/.*)?$ - [F,L]
    RewriteRule ^database(/.*)?$ - [F,L]
    RewriteRule ^routes(/.*)?$ - [F,L]
    RewriteRule ^resources(/.*)?$ - [F,L]
    RewriteRule ^app(/.*)?$ - [F,L]
    RewriteRule ^tests(/.*)?$ - [F,L]
    RewriteRule ^scripts(/.*)?$ - [F,L]

    # Block hidden files and directories (.env, .git, .github, etc.)
    RewriteRule (^\.|/\.) - [F,L]

    # ── 3. Redirect everything else to the public directory ───────
    RewriteCond %{REQUEST_URI} !^/public/
    RewriteRule ^(.*)$ /public/$1 [L]
</IfModule>

# Block access to sensitive file types in the project root
# Note: .php is NOT blocked here because public/index.php must remain accessible
<FilesMatch "\.(env|log|yml|yaml|lock|xml|ini|conf|sh|sql|bak|swp|dist|md)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block specific sensitive files by name
<FilesMatch "^(composer\.json|composer\.lock|package\.json|phpunit\.xml|artisan|server\.php|\.php_cs|\.styleci\.yml|\.eslintrc\.js)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Disable directory browsing
Options -Indexes
